<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
  <div class="page">
    <script src="js/js-tabler/demo-theme.min.js?1692870487"></script>
    <div class="page-wrapper" id="page-wrapper">
      <!-- Main Container -->
      <div class="container" id="container">
        <h2>[[${menuNm}]]</h2>
        <div class="ptag-container">
          <!-- <span><a href="#"> Home ></a></span> -->
          <span>[[${navigator}]]</span>
        </div>
        <!-- Form Container -->
        <div class="form-container">
          <div class="form-box">
            <form id="filter-form" name="form" method="post" action="/WRKFIL001M0SelectList" onsubmit="return false;">
              <div class="row align-items-center">
                <div class="col-auto">
                  <label class="form-label">Month: </label>
                  <select name="user[month]" class="form-select select-month-year p-1" id="inputMonth">
                    <option value="">Month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option selected="selected" value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <!-- <div class="col-3"></div> -->
                <div class="col-auto">
                  <label class="form-label">Year: </label>
                  <select name="user[year]" class="form-select select-month-year p-1" id="inputYear">
                    <option value="">Year</option>
                    <option value="2020">2020</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option selected="selected" value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                  </select>
                </div>
                <div class="col-auto">
                  <label class="form-label">Company Code / Name: </label>
                  <!-- <div class="input-group"> -->
                  <input id="companyCode" name="companyCode" type="text" class="form-control select-month-year p-1"
                    placeholder="insert value" />
                  <!-- </div> -->
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary search-button p-1" id="searchButton">
                    Search
                  </button>
                </div>
              </div>
              <div class="col text-end align-items-center me-2">
                <button type="button" class="btn btn-lime" style="padding: 4px 10px; color: white; font-size: 13px"
                  id="downloadExcel">
                  Download
                </button>
                <!-- <button
                    name="btnExcelDown"
                    type="button"
                    class="btn btn-lime"
                    style="padding: 4px 10px; color: white; font-size: 13px"
                    id="downloadExcel"
                    onclick="getExcelList()"
                    data-test="edit-button"
                  >
                    Download
                  </button> -->
                <!-- <button
                    name="btnSave"
                    type="button"
                    class="btn btn-secondary"
                    style="padding: 4px 10px; color: white; font-size: 13px"
                    onclick="setSaveUploadFile()"
                    data-test="edit-button"
                  >
                    Save
                  </button> -->
              </div>
              <!-- Extra space for folowing the form box-->
              <!-- <div style="padding-bottom: 1px"></div> -->
            </form>
          </div>
        </div>
      </div>
      <!-- Page content -->
      <div class="page-body">
        <div class="container-xl">
          <div class="row row-cards">
            <div class="col-12 mb-3">
              <div class="card card-md d-flex flex-column h-100">
                <div id="divMyGridBackup">
                  <table class="table" align="center"></table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="card card-md">
              <div class="container my-5">
                <canvas id="mixedChart" width="300" height="150"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="js/utils.js"></script>
    <script>
      function getCsList(input) {
        console.log("getCsList input : " + input);
        var option = {
          type: "POST",
          url: "/OPNSRV003M0getGridData",
          async: false,
          dataType: "json",
          contentType: "application/json; charset=utf-8",
          data: input
        };

        gf_Transaction(option, fn_callback);
      }
    </script>
    <script>
      $(document).ready(function () {
        console.log("Document is ready.");
        //화면 접속시 바로 조회
        main();
        //send버튼 누르면, 조건적용하여 검색
        $("#send").click(main);
        //엔터키누르면, 조건적용하여 검색
        $("input").on("keyup", function (key) {
          if (key.keyCode == 13) {
            main();
          }
        });
      });

      function fn_callback(result) {
        console.log("result data: ", result.data); 
        if(result.data){
          let data = result.data;
          generateRandomId(data); // generate random id for each data object
          fn_setGrid(data); // set the grid with the data
          return data;
        }
      }

      function generateRandomId(data) {
        data.forEach((item, index) => {
          item.uniqueId = index + 1;
        });
        console.log("data after the unique id generation: ", data);
        return data;

      }


      // slicgrid 관련 변수
      var grid;
      var dataView;
      // var unqId = "csNo";

      // var uniqueId = generateRandomId(data);
      // console.log("uniqueId after the random id genaration: ", uniqueId)
    
      var columns = [
        {
          id: "uniqueId",
          name: "ID",
          field: "uniqueId",
          editor: Slick.Editors.Text,
          validator: createValidator,
          width: 10,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        },
        {
          id: "compNm",
          name: "Company Name",
          field: "compNm",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 170,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        },
        {
          id: "srvcNm",
          name: "Service Name",
          field: "srvcNm",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 170,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        }, 
        {
          id: "dayCnt",
          name: "Usage Day Count",
          field: "dayCnt",
          sortable: true,
          editor: function (args) {
            return new ComboBoxEditor(args, [
              { key: "Y", value: "Y" },
              { key: "N", value: "N" },
            ]);
          },
          width: 60,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        }, 
        {
          id: "srvcCostSum",
          name: "Service Cost Amount",
          field: "srvcCostSum",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: createValidator,
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        },
        {
          id: "srvcCostTotal",
          name: "Service Cost Total",
          field: "srvcCostTotal",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: createValidator,
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        },
        {
          id: "srvcCostExpTotal",
          name: "Expected Total Cost",
          field: "srvcCostExpTotal",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-center",
        },
      ];

      var options = {
        enableCellNavigation: true,
        enableColumnReorder: false,
        forceFitColumns: true,
        multiColumnSort: true,
        numberedMultiColumnSort: true,
        tristateMultiColumnSort: true,
        sortColNumberInSeparateSpan: true,
        enableAutoSizeColumns: true,
        editable: false, // grid도 편집가능.. grid 편집 기능 제거 필요..
        enableAddRow: true,
        asyncEditorLoading: false,
        autoEdit: false,
        autoEditNewRow: false,
        //enableAutoResize: true
      };

      var newRowIds = 0;

      var pluginOptions = {
        clipboardCommandHandler: function (editCommand) {
          undoRedoBuffer.queueAndExecuteCommand.call(
            undoRedoBuffer,
            editCommand
          );
        },
        readOnlyMode: false,
        includeHeaderWhenCopying: false,
        newRowCreator: function (count) {
          for (var i = 0; i < count; i++) {
            var item = {
              id: "newRow_" + newRowIds++,
            };
            grid.getData().addItem(item);
          }
        },
      };

      function addSlickGridSomeStyling() {
        const style = document.createElement("style");
        style.innerHTML = `
             .slick-header-columns {
               font-family: San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
               font-size: 13px;
               font-weight: bold;
             }
             .slick-cell {
               font-family: San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
               font-size: 13px;
             }
           `;
        document.head.appendChild(style);
      }

      function main() {
        addSlickGridSomeStyling();
        // 그리드 초기화 및 데이터 로드
        console.log("Initializing SlickGrid...");

        const companyCode = document.getElementById("companyCode").value || ""
        console.log("company code: ", companyCode);

        // here we make a call to get the grid data
        getCsList(
          (input = JSON.stringify({
            csNo: companyCode
          }))
        );
      }

      function fn_setGrid(data) {
        console.log("sucessfully fetched data : ", data);
        console.log("fn_setGrid data : ", data);

        dataView = new Slick.Data.DataView();
        grid = new Slick.Grid(
          "#divMyGridBackup",
          dataView,
          columns,
          options
        );

        // Make the grid respond to DataView change events.
        dataView.onRowCountChanged.subscribe(function (e, args) {
          grid.updateRowCount();
          grid.render();
        });

        dataView.onRowsChanged.subscribe(function (e, args) {
          grid.invalidate();
          grid.render();
        });

       
        // setItems의 두번째 argument를 통해 unique id에 해당하는 컬럼 지정가능
        dataView.setItems(data, "uniqueId");
        console.log("dataView data: ", dataView.getItems());

        // when "onBeforeSort" returns false, the "onSort" won't execute (for example a backend server error while calling backend query to sort)
        // grid.onBeforeSort.subscribe(function (e, args) {
        //   return true;
        // });

        // 정렬 sorting
        grid.onSort.subscribe(function (e, args) {
          var cols = args.sortCols;

          data.sort(function (dataRow1, dataRow2) {
            for (var i = 0, l = cols.length; i < l; i++) {
              var field = cols[i].sortCol.field;
              var sign = cols[i].sortAsc ? 1 : -1;
              var value1 = dataRow1[field],
                value2 = dataRow2[field];
              var result =
                (value1 == value2 ? 0 : value1 > value2 ? 1 : -1) * sign;
              if (result != 0) {
                return result;
              }
            }
            return 0;
          });

          grid.invalidateAllRows();
          dataView.setItems(data, "uniqueId");
          grid.render();
        });

        grid.setSelectionModel(new Slick.CellSelectionModel());
        grid.registerPlugin(new Slick.AutoTooltips());

        // set keyboard focus on the grid
        //grid.getCanvasNode().focus();
        grid.registerPlugin(
          new Slick.CellExternalCopyManager(pluginOptions)
        );

        grid.onAddNewRow.subscribe(function (e, args) {
          var newItem = args.item;
          var column = args.column;
          dataView.beginUpdate();
          dataView.setItems(data);
          dataView.endUpdate();
          grid.updateRowCount();
          grid.render();
        });

        grid.onBeforeEditCell.subscribe(function (e, args) {
          console.log("onBeforeEditCell");
        });

        grid.onCellChange.subscribe(function (e, args) {
          dataView.beginUpdate();
          dataView.setItems(data);
          dataView.endUpdate();
          grid.updateRowCount();
          grid.render();
        });

        grid.onValidationError.subscribe(function (e, args) {
          // handle validation errors originating from the CompositeEditor
          if (args.validationResults) {
            let errorMsg = args.validationResults.msg || "";
            if (
              args.editor &&
              args.editor instanceof Slick.CompositeEditor
            ) {
              if (args.validationResults.errors) {
                errorMsg += "\n";
                args.validationResults.errors.forEach(function (
                  error,
                  errorIndex
                ) {
                  const columnName = error.editor.args.column.id;
                  errorMsg += `${columnName.toUpperCase()}: ${error.msg}`;
                });
              }
              console.log(errorMsg);
            }
          } else {
            alert(errorMessages);
          }
        });

        grid.setActiveCell(0, 0);
        console.log("SlickGrid initialized.");
      }

      let initlaizedChart;
      //  we have to wait for the DOM to load
      document.addEventListener("DOMContentLoaded", function () {
        // making a chart using chrt.js library will start here
        const ctx = document.getElementById("mixedChart").getContext("2d");

        // const mixedChart = new Chart(ctx, config);
        initlaizedChart = new Chart(ctx, {
          data: {
            labels: [],
            datasets: [],
          },
          options: {
            responsive: true,
            interaction: {
              mode: "index",
              intersect: false,
            },
            stacked: false,
            plugins: {
              title: {
                display: true,
                text: "Usage and Price Comparison",
                font: {
                  size: 18,
                  textAlign: "flex-start",
                },
              },
              tooltip: {
                enabled: true,
                mode: "index",
                intersect: false,
              },
              legend: {
                position: "top",
              },
            },
            scales: {
              // Primary y-axis for Sales (Bar Charts)
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Unit Number: ",
                  font: {
                    size: 14,
                  },
                  // align: "start", // we align the title to the start of the axis
                },
                ticks: {
                  beginAtZero: true,
                  min: 0,
                  max: 150,
                },
              },
              // Secondary y-axis for Prices (Line Charts)
              y1: {
                type: "linear",
                display: true,
                position: "right",
                grid: {
                  drawOnChartArea: false, // Only want the grid lines for one axis
                },
                title: {
                  display: true,
                  text: "Price ($)",
                  font: {
                    size: 14,
                  },
                },
                ticks: {
                  beginAtZero: false,
                },
              },
              y2: {
                type: 'linear',
                display: false,
                position: 'right',
                offset: true,
                title: {
                  display: true,
                  text: 'User Average',
                },
                grid: {
                  drawOnChartArea: false, 
                },
                ticks: {
                  beginAtZero: true,
                },
              },
            },
          },
        });

        // Function to update the chart with new data
        function updateChart(data) {
          // Extract the month label from the ymd data;
          const labels = data.map((item) => item.ymd);

          // column chart data
          const basicServiceCnt = data.map((item) => item.basicCnt || 0);
          const premiumServiceCnt = data.map((item) => item.premiumCnt || 0);

          const userAvgData = data.map((item) => item.userAvg || 0);

          // line chart data
          const totalCost = data.map((item) => item.srvcCostSum || null);

          // Method to filter total cost from the first date of the month until today
          const filterTotalCostUntilToday = (data) => {
            const today = new Date();
            const firstDateOfMonth = new Date(
              today.getFullYear(),
              today.getMonth(),
              1
            );

            return data
              .filter((item) => {
                const itemDate = new Date(item.ymd);
                return itemDate >= firstDateOfMonth && itemDate <= today;
              })
              .map((item) => item.srvcCost);
          };

          const filteredTotalCost = filterTotalCostUntilToday(data);

          const expectedCost = data.map(
            (item) => item.srvcCostExpSum || null
          );

          // Update the chart data
          initlaizedChart.data.labels = labels;
          initlaizedChart.data.datasets = [
            {
              type: "bar",
              label: "Basic Service Count",
              data: basicServiceCnt,
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              borderColor: "rgba(255, 99, 132, 1)",
              yAxisID: "y",
              orderWidth: 1,
              barThickness: "flex",
              maxBarThickness: 50,
            },
            {
              type: "bar",
              label: "Premium Service Count",
              data: premiumServiceCnt,
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              borderColor: "rgba(54, 162, 235, 1)",
              yAxisID: "y",
              orderWidth: 1,
              barThickness: "flex",
              maxBarThickness: 50,
            },
            {
              type: "line",
              label: "Total Cost",
              data: totalCost,
              fill: false,
              borderColor: "rgba(75, 192, 192, 1)",
              yAxisID: "y1",
              orderWidth: 2,
              spanGaps: true,
            },
            {
              type: "line",
              label: "Expected Cost",
              data: expectedCost,
              fill: false,
              borderColor: "rgba(255, 206, 86, 1)",
              yAxisID: "y1",
              orderWidth: 2,
              spanGaps: true,
            },
            {
              type: "line",
              label: "User Average",
              data: userAvgData,
              fill: false,
              borderColor: "rgba(153, 102, 255, 1)",
              yAxisID: "y2",
              orderWidth: 2,
              spanGaps: true,
            }
          ];

          // Update the chart
          initlaizedChart.update();
        }

        function inputValidation(input) {
          // we remove the non-digit characters 
          const numbersOnly = input.replace(/\D/g, "");

          // we check if the result stirng is exactly three digits 
          if (/^\d{3}$/.test(numbersOnly)) {
            numbersOnly
            return true;
          } else {
            alert("Please enter a valid company code!");
            return false;
          }
        }

        // search function to make a fetch call to the server
        function searchFunction() {
         

          if (
            $("#inputMonth").val() === "" &&
            $("#inputYear").val() === ""
          ) {
            alert("Please select a month, year !");
            return false;
          } else if ($("#inputYear").val() === "") {
            alert("Please select a year to continue!");
            return false;
          } else if ($("#inputMonth").val() === "") {
            alert("Please select a month to continue!");
            return false;
          }

          // these will be used to get the month and year from the user
          const month = document.getElementById("inputMonth").value;
          const year = document.getElementById("inputYear").value;
          const conpanyCode = document.getElementById("companyCode").value || "001";
          const stdYymm = year + month.padStart(2, "0");

          console.log("we came here to search for the data: ", stdYymm, conpanyCode); 
          // validaion methoid will be tirggered
          inputValidation(conpanyCode)

           // when the user clicks on the serach button, we update the gfrid data by making a call.
           main();

          // Send an AJAX GET request to the endpoint
          $.ajax({
            type: "POST",
            url: "/OPNSRV003M0getChartInfos",
            data: JSON.stringify({
              ymd: stdYymm,
              csNo: conpanyCode

            }),
            contentType: "application/json; charset=utf-8",
            async: true,
            dataType: "json",
            success: function (data) {
              console.log("Data received from the single ajax form:", data);
              // update the chart wwth the data
              updateChart(data);
            },
            error: function (xhr, status, error) {
              console.error("Error fetching data:", status, error);
            },
          });
        
        }

        // seafch button event listener
        const searchButton = document.getElementById("searchButton");

        searchButton.addEventListener("click", searchFunction);

        $(document).ready(function () {
          // we fetch the user subcrioption info
          // getUserSubscriptionInfo();
          searchFunction();
        });
      });

      // Download Excel functionality
      document
        .getElementById("downloadExcel")
        .addEventListener("click", function () {
          const currDate = getCurrentDateTime();
          const fileName = "WRKFIL001_FM_" + currDate; // 원하는 파일 이름으로 변경 가능
          const sheetName = "파일관리"; // 시트 이름
          const gridColumns = columns; // SlickGrid의 컬럼 배열
          const gridData = dataView.getItems(); // SlickGrid의 데이터 배열
          exportToExcel(fileName, sheetName, gridColumns, gridData);
        });
    </script>
  </div>
  <script src="js/utils.js"></script>
</th:block>
</html>