<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>파일업로드</title>
    <link rel="stylesheet" href="/js/slickgrid/dist/styles/css/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="/js/slickgrid/dist/styles/css/slick-alpine-theme.css" type="text/css"/>
    <link rel="stylesheet" href="/css/jquery-ui-1.13.3/jquery-ui.css" type="text/css"/>
    
    <script src="/js/jquery-3.7.1.min.js"></script>
    <script src="/js/slickgrid/lib/jquery.event.drag-2.3.0.js"></script>
    
    <script src="/js/slickgrid/dist/browser/slick.core.js"></script>
    <script src="/js/slickgrid/dist/browser/slick.interactions.js"></script>
    <script src="/js/slickgrid/dist/browser/slick.grid.js"></script>
    <script src="/js/slickgrid/dist/browser/plugins/slick.autotooltips.js"></script>
    <script src="/js/slickgrid/dist/browser/plugins/slick.cellrangedecorator.js"></script>
    <script src="/js/slickgrid/dist/browser/plugins/slick.cellrangeselector.js"></script>
    <script src="/js/slickgrid/dist/browser/plugins/slick.cellexternalcopymanager.js"></script>
    <script src="/js/slickgrid/dist/browser/plugins/slick.cellselectionmodel.js"></script>
    <script src="/js/slickgrid/dist/browser/slick.editors.js"></script>
    <script src="/js/slickgrid/dist/browser/slick.formatters.js"></script>
    
    <style>
        .slick-header-columns {
            /* flex-grow: 1 if we want to align sort icons to the right */
            --alpine-header-name-flex-grow: 1;
            }
        .slick-cell.copied {
          background: blue;
          background: rgba(0, 0, 255, 0.2);
          transition: 0.5s background;
        }
        /** override slick-cell to make it look like Excel sheet */
        .slick-container {
          --alpine-header-column-height: 20px;
          --alpine-header-font-weight: 500;
          --alpine-cell-border-width: 0 1px 1px 0;
          --alpine-cell-border-color: #d4d4d4;
        }
	header {
        height: 60px;
        border : solid 0.5px #000000;
        background-color: #BFD8F2;
		font-size:30px;
	}
	main {
        border: solid 0.5px #000000;
        width: 1200px;
        height: 700px;
	}
    aside {
        width: 120px;
        height: 900px;
        float: left;
        border: solid 0.5px #000000;
        background-color: #BFD8F2;

    }
    footer{
        height: 30px;
        margin: 2px;
        border: solid 0.5px #000000;
        background-color: #BFD8F2;
    }
    </style>
    <script>
        
        $(document).ready( function() 
                           {
                                console.log("Document is ready.");
                                $("input").on("keyup", function(key)
                                                       {
                                                            if (key.keyCode == 13)
                                                            {
                                                                 getSearchList();
                                                            }
                                                       });
                                // 파일관리화면의 조회부분 : TODO 공동으로 뺴놓기
                                // MyBatis를 통해 데이터를 가져오는 AJAX 요청
                                $.ajax({
                                    type: 'post',
                                    url: '/WRKFIL003M0SelectFileList',
                                    async: false,
                                    dataType: 'json',
                                    contentType: 'application/json; charset=utf-8',
                                    data: JSON.stringify({
                                                   uploadFile : ""
                                                 , stdYymm    : ""
                                                }),
                                    success: function(response) {
                                        populateDropdown(response);
                                    },
                                    error: function(error) {
                                        console.error('Error fetching file names:', error);
                                    }
                                });
                            
                                // DropDown 리스트에 FILE_NM 값을 추가하는 함수
                                function populateDropdown(data) {
                                    var dropdown = $('#cmbUploadFileList');
                                    data.forEach(function(item) {
                                        var option = $('<option></option>').attr('value', item.seqNo).text(item.tblId+"("+item.fileNm+")");
                                        dropdown.append(option);
                                    });
                                }
                           });

        function getExcelList() 
        {
             alert("Excel test");
        }

        function getSearchList() 
        {
            console.log("Sending AJAX request...");
            
            const element = document.getElementById('divGrdMain');
            element.innerHTML = '';
            
            $.ajax({
                     type       : 'post'
                   , url        : '/WRKFIL003M0SelectList'
                   , async      : true
                   , dataType   : 'json'
                   , contentType: 'application/json; charset=utf-8'
                   , data       : JSON.stringify({
                                                   uploadFile : $("#cmbUploadFileList").val()
                                                 , stdYymm    : $("#inpStdYymm").val()
                                                })
                
                   , success: function(data) 
                              {
                                   console.log("AJAX request successful. Data received:", data);
                                   
                                   var grdData = data.data;
                                   var grdHead = data.grdHead;
                                   
                                   if (grdData && grdData.length > 0)
                                   {
                                        // 컬럼 생성
                                        var newRowIds = 0;
                                        var pluginOptions = {
                                                                clipboardCommandHandler  : function(editCommand){ undoRedoBuffer.queueAndExecuteCommand.call(undoRedoBuffer,editCommand); }
                                                              , readOnlyMode             : false
                                                              , includeHeaderWhenCopying : false
                                                              , newRowCreator            : function(count) 
                                                                                           {
                                                                                                for (var i = 0; i < count; i++) 
                                                                                                {
                                                                                                    var item = { id: "newRow_" + newRowIds++ }
                                                                                                    grid.getData().addItem(item);
                                                                                                }
                                                                                            }
                                                            };
                                        
                                        var columns = [];
                                        /*
                                        var keys    = Object.keys(grdData[0]);
                                        
                                        for (var i = 0; i < keys.length; i++)
                                        {
                                            columns.push({ id: keys[i], name: keys[i], field: keys[i], sortable: true, editor: Slick.Editors.Text });
                                        }
                                        */
                                        
                                        for (var i = 0; i < grdHead.length; i++)
                                        {
                                            
                                            var sCd = grdHead[i].CD;
                                            var sNm = grdHead[i].NM;
                                            
                                            columns.push({ id: sCd, name: sNm, field: sCd, sortable: true, editor: Slick.Editors.Text });
                                        }
                                        
                                        // 그리드 옵션
                                        var options = {
                                                           enableCellNavigation       : true
                                                         , enableColumnReorder        : false
                                                         , forceFitColumns            : true
                                                         , multiColumnSort            : true
                                                         , numberedMultiColumnSort    : true
                                                         , tristateMultiColumnSort    : true
                                                         , sortColNumberInSeparateSpan: true
                                                         , enableAutoSizeColumns      : true
                                                         , editable                   : false
                                                         , enableAddRow               : true
                                                         , asyncEditorLoading         : false
                                                         , autoEdit                   : false
                                                         , autoEditNewRow             : false
                                                      };
                                        
                                        // 그리드 초기화 및 데이터 로드
                                        console.log("Initializing SlickGrid...");
                                        
                                        var grid = new Slick.Grid("#divGrdMain", grdData, columns, options);
                                        
                                        // when "onBeforeSort" returns false, the "onSort" won't execute (for example a backend server error while calling backend query to sort)
                                        grid.onBeforeSort.subscribe(function (e, args) 
                                                                    {
                                                                         return true;
                                                                    });
                                        
                                        // 정렬
                                        grid.onSort.subscribe(function (e, args) 
                                                              {
                                                                   var cols = args.sortCols;
                                                                   
                                                                   grdData.sort(function (dataRow1, dataRow2) 
                                                                             {
                                                                                  for (var i = 0, l = cols.length; i < l; i++) 
                                                                                  {
                                                                                       var field  = cols[i].sortCol.field;
                                                                                       var sign   = cols[i].sortAsc ? 1 : -1;
                                                                                       var value1 = dataRow1[field], value2 = dataRow2[field];
                                                                                       var result = (value1 == value2 ? 0 : (value1 > value2 ? 1 : -1)) * sign;
                                                                                       if (result != 0) 
                                                                                       {
                                                                                            return result;
                                                                                       }
                                                                                   }
                                                                                   return 0;
                                                                             });
                                                                   grid.invalidate();
                                                                   grid.render();
                                                              });
                                        
                                        grid.setSelectionModel(new Slick.CellSelectionModel());
                                        grid.registerPlugin(new Slick.AutoTooltips());
                                        
                                        // set keyboard focus on the grid
                                        grid.getCanvasNode().focus();
                                        
                                        grid.registerPlugin(new Slick.CellExternalCopyManager(pluginOptions));
                                        
                                        grid.onAddNewRow.subscribe(function (e, args) 
                                                                   {
                                                                        var item   = args.item;
                                                                        var column = args.column;
                                                                        grid.invalidateRow(grdData.length);
                                                                        grdData.push(item);
                                                                        grid.updateRowCount();
                                                                        grid.render();
                                                                   });
                                        
                                        console.log("SlickGrid initialized.");
                                   }
                                   else
                                   {
                                        console.log("No data returned from the server.");
                                   }
                              }
                   , error: function(xhr, status, error) 
                            {
                                console.error("!!!! ERROR !!!!!", status, error);
                            }
            });
        }
        function setSaveUploadFile() 
        {
            console.log("Sending AJAX request...");
            
            //let form = $('#uploadFrm')[0];
            //let frmData = new FormData(form);
            
            var formData = new FormData();
            var inputFile = $("input[name='btnFileUpload']");
            var files = inputFile[0].files;
            console.log(files);
            
            for(var i =0;i<files.length;i++){
                
                formData.append("uploadFile", files[i]);
            }
            
            formData.append("$$param$$", new Blob([JSON.stringify({
                                                                uploadFile : $("#cmbUploadFileList").val()
                                                              , stdYymm    : $("#inpStdYymm").val()
                                                              })], {type: "application/json"}))

            $.ajax({
                //enctype: 'multipart/form-data',
                //contentType: 'multipart/form-data; charset=utf-8',
                type: 'POST',
                url        : '/WRKFIL003M0SaveUploadFile',
                processData: false,   
                contentType: false,
                cache: false,
                //file: files,
                data: formData,
                success: function(data) {
                    console.log(data);
                    
                    alert('파일업로드 저장 성공');
                    
                    var agent = navigator.userAgent.toLowerCase();
                    //파일초기화
                    if ( (navigator.appName == 'Netscape' && navigator.userAgent.search('Trident') != -1) 
                         || (agent.indexOf("msie") != -1) ) {
                        $("#btnFileUpload").replaceWith($("#btnFileUpload").clone(true));
                    } else {
                        $("#btnFileUpload").val("");
                    }
                    
                    getSearchList();
                },
                error: function(e) {
                    console.log(e);
                    alert('파일업로드 저장 실패');
                }
            });
            
        }
        
        function clearSlickGridData(){
            var grid = new Slick.Grid("#divGrdMain", [{}], [{}], [{}]);
        }

    </script>
</head>
<!---------- header,left (시작) -------------->
    <header align="center">
	<b>File Management System(Extract,Load,View)</b>
	<img height="60" src="/images/img_charater.png" align="right"></header>
	<aside>
	  &nbsp;파일관리<br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/WRK/FIL/WRKFIL001M0.html" target="main">파일관리</a><br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/WRK/FIL/WRKFIL002M0.html" target="main">칼럼관리</a><br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/WRK/FIL/WRKFIL003M0.html" target="main">업로드  </a><br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/WRK/FIL/WRKFIL004M0.html" target="main">적재이력</a><br>
	  &nbsp;&nbsp;&nbsp;검증관리(X)                                <br>
	  &nbsp;&nbsp;&nbsp;검증결과(X)                                <br>
	  &nbsp;&nbsp;&nbsp;파일목록(X)                                <br>
	  &nbsp;시스템관리<br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/MST/SYS/MSTSYS001M0.html" target="main">사용자관리</a><br>
	  &nbsp;&nbsp;&nbsp;<a href ="/views/MST/SYS/MSTSYS002M0.html" target="main">코드관리</a><br>
	  &nbsp;&nbsp;&nbsp;게시판(X)<br>
	  &nbsp;배치관리<br>
	  &nbsp;&nbsp;&nbsp;배치목록(ing)<br>
	  &nbsp;&nbsp;&nbsp;배치실행(X)<br>
	  &nbsp;배치관리<br>
	  &nbsp;&nbsp;&nbsp;데이터현황(X)<br>
	  &nbsp;&nbsp;&nbsp;데이터상세(X)<br>
	  &nbsp;ETL<br>
	  &nbsp;&nbsp;&nbsp;DBtoDB(X)<br>
	  &nbsp;&nbsp;&nbsp;DBtoFile(X)<br>
	  &nbsp;&nbsp;&nbsp;FileToDb(X)<br>
	</aside>
<!---------- header,left (종료) -------------->
<body>
    <form id="divSearch" name="divSearch">
        <p>
            <label for="lblStdYymm">기준년월 : </label>
            <input id="inpStdYymm" name="inpStdYymm" required="required" type="text" />
            &nbsp;
            <label for="lblUploadFileList">업로드 파일 : </label>
            <select id="cmbUploadFileList" name="cmbUploadFileList" required="required">
                <option selected="selected" value="">- 선택 -</option>
            </select>
            &nbsp;
            <form method="post" id="uploadFrm" enctype="multipart/form-data">
                <input id="btnFileUpload" name="btnFileUpload" type="file" value="파일선택" accept=".xlsx, .xls" />
            </form>
            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
            <input name="btnSave" type="button" value="저장" onclick="setSaveUploadFile()" />
            &nbsp;
            <input name="btnSearch" type="button" value="조회" onclick="getSearchList()" />
            &nbsp;
            <input name="btnExcelDown" type="button" value="엑셀다운" onclick="getExcelList()" />
        </p>
    </form>
    <form name="divData">
        <p>►&nbsp;<label for="lblGrdTitle">그리드 제목</label></p>
        
        <table align="center" border="1" cellpadding="1" cellspacing="1" style="width:500px">
            <div id="divGrdMain" style="width:800px;height:750px;"></div>
        </table>
    </form>
</body>
</html>
