<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
	<div class="page">
		<script src="js/demo-theme.min.js?1692870487"></script>
		<div class="page-wrapper" id="page-wrapper">
			<div class="container" id="'container">
				<h2>File Input</h2>
				<div class="ptag-container">
					<span><a href="#"> Home ></a></span> <span><a href="#"> File Input</a></span>

					<div class="form-container">
						<div class="form-box">
							<form id="filter-form" name="form" method="post" action="/WRKFIL001M0SelectList" onsubmit="return false;">
								<div class="row">
									<div class="col">
										<label for="fileDropdown">Select a file:</label>
										<select id="fileDropdown" style="padding: 3px">
											<option value="">- options -</option>
										</select>
									</div>

									<!-- <button type="button" class=" btn btn-pill" onclick="main()">
	                          Search
	                        </button> -->
								</div>
								<div class="col text-end">
									<button type="button" class=" btn btn-primary" style="padding: 4px 10px; color: white; font-size: 13px;" form="new-form" onclick="renewOptions(true);openDetails('create');{(ev) => {if (ev.detail === 0) {ev.preventDefault();}}}" data-test="create-button" onsubmit="return false;">Create</button>
									<button type="button" class="btn btn-lime" style="padding: 4px 10px; color: white; font-size: 13px;" id="downloadExcel" form="new-form" onclick="renewOptions(true);openDetails('edit');{(ev) => {if (ev.detail === 0) {ev.preventDefault();}}}" data-test="edit-button" onsubmit="return false;">Download</button>

									<button type="button" class=" btn btn-secondary" style="padding: 4px 10px; color: white; font-size: 13px;" form="new-form" onclick="renewOptions(true);openDetails('edit');{(ev) => {if (ev.detail === 0) {ev.preventDefault();}}}" data-test="edit-button" onsubmit="return false;">Edit</button>

								</div>
						</div>
						<div class="row mt-3"></div>
						</form>
					</div>
				</div>
				<div style="padding-top: 2em"></div>
				<div id="divMyGrid">
					<table align="center" class="table"></table>
				</div>
				<div>
					<div class="popupDataForm">
						<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" style="display: none;">Launch modal with form</button>

						<div class="modal fade" id="exampleModal" tabindex="-1" style="display: none">
							<div class="modal-dialog modal-small" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title">New report</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>

									<div class="modal-body">
										<div class="row">
											<div class="col-lg-6">
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Client name</label> <input type="text" class="form-control" />
												</div>
											</div>
											<div class="col-lg-6">
												<div class="mb-3">
													<label class="form-label">Reporting period</label> <input type="date" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Reporting period</label> <input type="date" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Reporting period</label> <input type="date" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Reporting period</label> <input type="date" class="form-control" />
												</div>
												<div class="mb-3">
													<label class="form-label">Reporting period</label> <input type="date" class="form-control" />
												</div>
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal"> Cancel </a> <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal" style="padding: 4px 10px; color: white; font-size: 13px;"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12 5l0 14"></path> <path d="M5 12l14 0"></path> </svg> Save changes
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>
	</div>
	<script>
	        function checkData(data) {
	          return parentCheckData(data, check_cols);
	        }
	
	        function getFile(input) {
	          return parentGetFile(input, "/WRKFIL002M1SelectList");
	        }
	
	        function insertFile(addedRow) {
	          parentInsertFile(addedRow, "/WRKFIL002M0InsertList");
	        }
	
	        function updateFile(updatedRow) {
	          parentUpdateFile(updatedRow, "/WRKFIL002M0UpdateList");
	        }
	
	        function deleteFile(todeleteRow) {
	          parentDeleteFile(todeleteRow, "/WRKFIL002M0DeleteList");
	        }
	    </script>
	<script>
	        var selectedValue = "";
	
	        $(document).ready(function () {
	          console.log("Document is ready.");
	
	          // MyBatis를 통해 데이터를 가져오는 AJAX 요청
	          $.ajax({
	            type: "post",
	            url: "/WRKFIL002M0SelectList",
	            async: false,
	            dataType: "json",
	            contentType: "application/json; charset=utf-8",
	            data: JSON.stringify({
	              dummyStr: "",
	            }),
	            success: function (response) {
	              populateDropdown(response);
	            },
	            error: function (error) {
	              console.error("Error fetching file names:", error);
	            },
	          });
	
	          // DropDown 리스트에 FILE_NM 값을 추가하는 함수
	          function populateDropdown(data) {
	            var dropdown = $("#fileDropdown");
	            data.forEach(function (item) {
	              var option = $("<option></option>")
	                .attr("value", item.tblId)
	                .text(item.tblId + "(" + item.fileNm + ")");
	              dropdown.append(option);
	            });
	          }
	
	          $(document).ready(function () {
	            // 버튼 클릭 시 선택된 값을 가져오는 이벤트 핸들러
	            $("#fileDropdown").change(function () {
	              selectedValue = $(this).val(); // 선택된 값 가져오기
	              main();
	            });
	          });
	          main();
	          //화면 접속시 바로 조회
	          //main();
	        });
	
	        var grid;
	        var dataView;
	        var data;
	        var unqId = "itmId";
	        var xcpt_cols = ["tblId", "regUsrid", "regDt"];
	        var check_cols = [unqId];
	        var columns = [
	          //{id: "tblId",    name: "테이블ID", field: "tblId", sortable: true, editor: Slick.Editors.Text},
	          {
	            id: "itmNm",
	            name: "칼럼명",
	            field: "itmNm",
	            sortable: true,
	            editor: Slick.Editors.Text,
	            validator: (value, args) =>
	              complexValidator(value, args, [
	                createValidator,
	                noWhitespaceValidator,
	              ]),
	          },
	          {
	            id: unqId,
	            name: "칼럼ID",
	            field: unqId,
	            sortable: true,
	            editor: Slick.Editors.Text,
	            validator: (value, args) =>
	              complexValidator(value, args, [
	                createValidator,
	                noWhitespaceValidator,
	              ]),
	          },
	          {
	            id: "dataTpCd",
	            name: "데이터타입코드",
	            field: "dataTpCd",
	            sortable: true,
	            editor: function (args) {
	              return new ComboBoxEditor(args, [
	                { key: "VARCHAR", value: "VARCHAR" },
	                { key: "NUMBER", value: "NUMBER" },
	                { key: "DATE", value: "DATE" },
	                { key: "TIMESTAMP", value: "TIMESTAMP" },
	              ]);
	            },
	          },
	          {
	            id: "pkYn",
	            name: "PK여부",
	            field: "pkYn",
	            sortable: true,
	            editor: function (args) {
	              return new ComboBoxEditor(args, [
	                { key: "Y", value: "Y" },
	                { key: "N", value: "N" },
	              ]);
	            },
	          },
	          {
	            id: "vlvlVrfYn",
	            name: "유효값검증여부",
	            field: "vlvlVrfYn",
	            sortable: true,
	            editor: function (args) {
	              return new ComboBoxEditor(args, [
	                { key: "Y", value: "Y" },
	                { key: "N", value: "N" },
	              ]);
	            },
	          },
	          {
	            id: "vlvlCd",
	            name: "유효값코드",
	            field: "vlvlCd",
	            sortable: true,
	            editor: Slick.Editors.Text,
	          },
	          {
	            id: "ordSeq",
	            name: "정렬순서",
	            field: "ordSeq",
	            sortable: true,
	            editor: Slick.Editors.Text,
	            validator: (value, args) =>
	              complexValidator(value, args, [
	                createValidator,
	                noWhitespaceValidator,
	              ]),
	          },
	          {
	            id: "itmDsc",
	            name: "항목설명",
	            field: "itmDsc",
	            sortable: true,
	            editor: Slick.Editors.Text,
	          },
	          {
	            id: "selBasYn",
	            name: "적재기준여부",
	            field: "selBasYn",
	            sortable: true,
	            editor: Slick.Editors.Text,
	          },
	        ];
	
	        var options = {
	          enableCellNavigation: true,
	          enableColumnReorder: false,
	          forceFitColumns: true,
	          multiColumnSort: true,
	          numberedMultiColumnSort: true,
	          tristateMultiColumnSort: true,
	          sortColNumberInSeparateSpan: true,
	          enableAutoSizeColumns: true,
	          editable: false, // grid도 편집가능.. grid 편집 기능 제거 필요..
	          enableAddRow: true,
	          asyncEditorLoading: false,
	          autoEdit: false,
	          autoEditNewRow: false,
	        };
	
	        var newRowIds = 0;
	
	        var pluginOptions = {
	          clipboardCommandHandler: function (editCommand) {
	            undoRedoBuffer.queueAndExecuteCommand.call(
	              undoRedoBuffer,
	              editCommand
	            );
	          },
	          readOnlyMode: false,
	          includeHeaderWhenCopying: false,
	          newRowCreator: function (count) {
	            for (var i = 0; i < count; i++) {
	              var item = {
	                id: "newRow_" + newRowIds++,
	              };
	              grid.getData().addItem(item);
	            }
	          },
	        };
	
	        function main() {
	          // 그리드 초기화 및 데이터 로드
	          console.log("Initializing SlickGrid...");
	          console.log("선택된 value: ", selectedValue);
	          data = getFile((input = JSON.stringify({ tblIdTxt: selectedValue })));
	
	          dataView = new Slick.Data.DataView({ idField: unqId });
	          grid = new Slick.Grid("#divMyGrid", dataView, columns, options);
	
	          // Make the grid respond to DataView change events.
	          dataView.onRowCountChanged.subscribe(function (e, args) {
	            grid.updateRowCount();
	            grid.render();
	          });
	
	          dataView.onRowsChanged.subscribe(function (e, args) {
	            grid.invalidate();
	            grid.render();
	          });
	
	          // setItems의 두번째 argument를 통해 unique id에 해당하는 컬럼 지정가능
	          dataView.setItems(data, unqId);
	
	          // when "onBeforeSort" returns false, the "onSort" won't execute (for example a backend server error while calling backend query to sort)
	          grid.onBeforeSort.subscribe(function (e, args) {
	            return true;
	          });
	
	          // 정렬
	          grid.onSort.subscribe(function (e, args) {
	            var cols = args.sortCols;
	
	            data.sort(function (dataRow1, dataRow2) {
	              for (var i = 0, l = cols.length; i < l; i++) {
	                var field = cols[i].sortCol.field;
	                var sign = cols[i].sortAsc ? 1 : -1;
	                var value1 = dataRow1[field],
	                  value2 = dataRow2[field];
	                var result =
	                  (value1 == value2 ? 0 : value1 > value2 ? 1 : -1) * sign;
	                if (result != 0) {
	                  return result;
	                }
	              }
	              return 0;
	            });
	
	            grid.render();
	          });
	
	          grid.setSelectionModel(new Slick.CellSelectionModel());
	          grid.registerPlugin(new Slick.AutoTooltips());
	
	          // set keyboard focus on the grid
	          grid.getCanvasNode().focus();
	          grid.registerPlugin(new Slick.CellExternalCopyManager(pluginOptions));
	
	          grid.onAddNewRow.subscribe(function (e, args) {
	            var newItem = args.item;
	            var column = args.column;
	            dataView.beginUpdate();
	            dataView.setItems(data);
	            dataView.endUpdate();
	            grid.updateRowCount();
	            grid.render();
	          });
	
	          grid.onBeforeEditCell.subscribe(function (e, args) {
	            console.log("onBeforeEditCell");
	          });
	
	          grid.onCellChange.subscribe(function (e, args) {
	            dataView.beginUpdate();
	            dataView.setItems(data);
	            dataView.endUpdate();
	            grid.updateRowCount();
	            grid.render();
	          });
	
	          grid.onValidationError.subscribe(function (e, args) {
	            // handle validation errors originating from the CompositeEditor
	            if (args.validationResults) {
	              let errorMsg = args.validationResults.msg || "";
	              if (args.editor && args.editor instanceof Slick.CompositeEditor) {
	                if (args.validationResults.errors) {
	                  errorMsg += "\n";
	                  args.validationResults.errors.forEach(function (
	                    error,
	                    errorIndex
	                  ) {
	                    const columnName = error.editor.args.column.id;
	                    errorMsg += `${columnName.toUpperCase()}: ${error.msg}`;
	                  });
	                }
	                console.log(errorMsg);
	              }
	            } else {
	              alert(errorMessages);
	            }
	          });
	
	          grid.setActiveCell(0, 0);
	          console.log("SlickGrid initialized.");
	        }
	
	        // Download Excel functionality
	        document
	          .getElementById("downloadExcel")
	          .addEventListener("click", function () {
	            const currDate = getCurrentDateTime();
	            const fileName = "WRKFIL002M1_CM_" + currDate; // 원하는 파일 이름으로 변경 가능
	            const sheetName = "파일관리"; // 시트 이름
	            const gridColumns = columns; // SlickGrid의 컬럼 배열
	            const gridData = dataView.getItems(); // SlickGrid의 데이터 배열
	            exportToExcel(fileName, sheetName, gridColumns, gridData);
	          });
	
	        // 신규버튼 누르면 동작하는 함수
	        function openDetails(modalType) {
	          grid.render();
	
	          let originalData = null; // 수정 직전의 데이터를 저장할 변수
	
	          if (
	            grid.getEditorLock().isActive() &&
	            !grid.getEditorLock().commitCurrentEdit()
	          ) {
	            return;
	          }
	
	          //신규버튼을 누르면 가장 아래 셀을 선택 후 신규만 입력하도록 ActiveCell을 설정
	          if (modalType === "create") {
	            grid.setActiveCell(grid.getDataLength(), 0);
	          }
	          var activeCell = grid.getActiveCell();
	          var activeRow = (activeCell && activeCell.row) || 0;
	
	          if (!options.enableCellNavigation) {
	            throw new Error(
	              'Composite Editor requires the flag "enableCellNavigation" to be set to True in your Grid Options.'
	            );
	          } else if (!activeCell && modalType === "edit") {
	            throw new Error("No records selected for edit operation");
	          } 
	            // var dataContext = grid.getDataItem(activeRow);
	            // var isWithMassUpdate =
	            //   modalType === "mass-update" || modalType === "mass-selection";
	            // lastActiveRowNumber = activeRow;
	
	            // // 수정 직전의 데이터 저장
	            // if (modalType === "edit") {
	            //   try {
	            //     originalData = JSON.parse(JSON.stringify(dataContext));
	            //   } catch {}
	            
	
	            const dataContext = grid.getDataItem(activeRow);
	            const modalElement = new bootstrap.Modal(document.getElementById("exampleModal"));
	            const modalTitleElem = document.querySelector(".modal-title");
	            const modalBodyElem = document.querySelector(".modal-body");
	            console.log("modalTitleElem:", modalTitleElem);
	
	            modalBodyElem.innerHTML = ""; // Clear previous content
	
	            if(modalTitleElem){
	              if(modalType ==="create"){
	                modalTitleElem.textContent = "Create a new file";
	              } else if(modalType === "edit"){
	                modalTitleElem.textContent = "Edit the file";
	                originalData = JSON.parse(JSON.stringify(dataContext));
	              }
	            }
	
	            // Dynamically create form elements based on the columns that have editors
	            const modalColumns = columns.filter(col => col.editor);
	
	            const columnsPerShow = 6;
	            let currentRow;
	
	            modalColumns.forEach((column, index) => {
	              // we create new row after 6 columms, 
	              if(index % columnsPerShow === 0){
	                currentRow = document.createElement("div")
	                currentRow.className = "row";
	                modalBodyElem.appendChild(currentRow);
	              }
	
	              const colElem = document.createElement("div");
	              colElem.className = "col-lg-6";
	
	              const formGroupElem = document.createElement("div");
	              formGroupElem.className = "mb-3";
	
	              const detailLabelitem = document.createElement("div");
	              detailLabelitem.className = "form-label";
	              detailLabelitem.textContent = column.name;
	
	              const inputElem = document.createElement('input');
	              inputElem.className = "form-control";
	              inputElem.dataset.editorid = column.id;
	              inputElem.value = modalType == "edit" ? dataContext[column.field] : ""; // pre-filling in the edit mode;
	
	              formGroupElem.appendChild(detailLabelitem);
	              formGroupElem.appendChild(inputElem);
	
	              colElem.appendChild(formGroupElem);
	
	              currentRow.appendChild(colElem);
	            })
	
	            if(modalColumns.length % columnsPerShow !== 0){
	              const remainingCols = columnsPerShow - (modalColumns.length % columnsPerShow);
	              const spacerCol = document.createElement('div');
	              spacerCol.className = `col-lg-${remainingCols * 2}`;  // adjust the spacer column
	              currentRow.appendChild(spacerCol);
	            }
	
	            modalElement.show();
	
	
	            // focus on a first cell with an Editor (unless current cell already has an Editor then do nothing)
	            // also when it's a "Create" modal, we'll scroll to the end of the grid
	            var rowIndex = modalType === "create" ? data.length : activeRow;
	            focusOnFirstCellWithEditor(columns, rowIndex, isWithMassUpdate);
	
	            if (modalType === "edit" && !dataContext) {
	              alert("Current row is not editable");
	              return;
	            } else if (modalType === "mass-selection") {
	              var selectedRowsIndexes = grid.getSelectedRows();
	              if (selectedRowsIndexes.length < 1) {
	                alert(
	                  "You must select some rows before trying to apply new value(s)"
	                );
	                return;
	              }
	            }
	
	
	            //업데이트 대상제외 컬럼 필터링
	            var selColumns = [];
	            for (let index = 0; index < columns.length; index++) {
	              const element = columns[index];
	              if (xcpt_cols.includes(element["id"])) {
	                continue;
	              } else {
	                selColumns.push(element);
	              }
	            }
	
	            if (isWithMassUpdate) {
	              // when using Mass Update, we only care about the columns that have the "massUpdate: true", we disregard anything else
	              modalColumns = selColumns.filter(function (col) {
	                return col && col.massUpdate && col.editor;
	              });
	            } else {
	              modalColumns = selColumns.filter(function (col) {
	                return col && col.editor;
	              });
	            }
	
	            let headerTitle = "";
	            switch (modalType) {
	              case "create":
	                headerTitle = "파일 추가";
	                break;
	              case "edit":
	                headerTitle = `Editing ${dataContext.title}`;
	                break;
	              case "mass-update":
	                headerTitle = "Mass Update (all rows)";
	                break;
	              case "mass-selection":
	                headerTitle = "Update on Current Selection";
	                break;
	            }
	
	            const modalElm = document.createElement("div");
	            modalElm.className = "modal slick-composite-editor-modal";
	
	            const modalHeaderElm = document.createElement("div");
	            modalHeaderElm.className = "modal-header";
	            modalHeaderElm.innerHTML = `<h5>${headerTitle}</h5>
	                <button type="button" class="close" data-action="close" aria-label="Close">
	                  <span aria-hidden="true">×</span>
	                </button>`;
	            modalElm.appendChild(modalHeaderElm);
	
	            const modalBodyElm = document.createElement("div");
	            modalBodyElm.className = "modal-body";
	            modalBodyElm.id = "modalForm";
	
	            for (const column of modalColumns) {
	              if (column.editor) {
	                const detailLabelElm = document.createElement("div");
	                detailLabelElm.className = `item-details-label editor-${column.id}`;
	                detailLabelElm.textContent = column.name;
	
	                const detailContainerElm = document.createElement("div");
	                detailContainerElm.className = "item-details-editor-container";
	                detailContainerElm.dataset.editorid = column.id;
	                detailContainerElm.style.height =
	                  column.id === "desc" ? "inherit" : "20px";
	
	                const detailValidationElm = document.createElement("div");
	                detailValidationElm.className = `item-details-validation editor-${column.id}`;
	
	                modalBodyElm.appendChild(detailLabelElm);
	                modalBodyElm.appendChild(detailContainerElm);
	                modalBodyElm.appendChild(detailValidationElm);
	              }
	            }
	            modalElm.appendChild(modalBodyElm);
	
	
	            //modal을 마우스로 드래그가능하도록 설정
	            $(".modal").draggable();
	
	            grid.onClick.subscribe(function (e, args) {
	              renewOptions(false);
	            });
	
	            // Save button logic
	          const saveBtn = document.querySelector(".modal-footer .btn-primary");
	          saveBtn.removeEventListener("click", saveHandler);
	          saveBtn.addEventListener("click", saveHandler);
	
	          // saveBtn.textContent = modalType === "create" ? "Create" : "Save changes";
	          function saveHandler(){
	            
	              const formData = {};
	
	              // Collect form data
	              modalColumns.forEach(column => {
	                  const input = modalBodyElem.querySelector(`[data-editorid="${column.id}"]`);
	                  if (input) {
	                      formData[column.field] = input.value.trim();
	                  }
	              });
	
	              if (modalType === "create") {
	                  // Add new item to grid data
	                  if (checkData(formData)) {
	                      formData[unqId] = grid.getDataLength() + 1;
	                      dataView.insertItem(grid.getDataLength(), formData);
	                  } else {
	                      alert("Please fill out all required fields.");
	                      return;
	                  }
	              } else if (modalType === "edit") {
	                  // Update existing item in grid data
	                  let isChanged = false;
	                  for (let key in formData) {
	                      if (formData[key] !== originalData[key]) {
	                          isChanged = true;
	                          break;
	                      }
	                  }
	
	                  if (isChanged) {
	                      formData[unqId] = originalData[unqId];
	                      dataView.updateItem(originalData[unqId], formData);
	                  } else {
	                      alert("No changes detected.");
	                      return;
	                  }
	              }
	              grid.render();
	              modalElement.hide(); // Hide the modal after saving\ 
	          };
	
	          // Close button logic
	          const closeBtn = document.querySelector(".modal-footer .btn-link");
	          closeBtn.removeEventListener("click", closeHandler);
	          closeBtn.addEventListener("click", closeHandler);
	
	          function closeHandler(){
	            if(modalType === "edit" && originalData){
	              dataView.updateItem(originalData[unqId], originalData);
	            }
	            modalElement.hide(); // we hide the modal
	          }
	
	          closeBtn.addEventListener("click", function () {
	              if (modalType === "edit" && originalData) {
	                  dataView.updateItem(originalData[unqId], originalData); // Revert changes if canceled
	              }
	          }); 
	        }
	    </script>
</th:block>
</html>
